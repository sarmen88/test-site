<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی دبرنا</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            direction: rtl;
            margin: 0;
            background-color: #f9f9f9;
            padding: 10px;
        }
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        .cards-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
        }
        .card {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            width: 90%;
            max-width: 400px;
        }
        .cell {
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }
        .cell.filled {
            background-color: #f0f0f0;
        }
        .cell.selected {
            background-color: #4caf50;
            color: #fff;
        }
        .cell.missed {
            background-color: red;
            color: white;
        }
        .number-display {
            font-size: 2em;
            font-weight: bold;
            margin: 20px auto;
            background-color: #007bff;
            color: white;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 50%;
        }
        .score, .timer {
            font-size: 1.2em;
            margin: 10px 0;
        }
        .timer {
            color: #d9534f;
            font-weight: bold;
        }
        .start-btn {
            font-size: 1.2em;
            padding: 10px 20px;
            margin-top: 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .start-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .form-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f1f1f1;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .form-container input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .form-container button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .form-container button:hover {
            background-color: #0056b3;
        }
        #gameContainer {
            display: none;
        }
        @media (max-width: 768px) {
            .cell {
                font-size: 1em;
            }
            .number-display {
                font-size: 1.5em;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <h1>بازی دبرنا</h1>

    <!-- فرم ورود -->
    <div id="loginContainer" class="form-container">
        <h2>ورود</h2>
        <form id="loginForm">
            <input type="text" id="loginMobile" name="loginMobile" placeholder="شماره موبایل" required>
            <input type="password" id="loginPassword" name="loginPassword" placeholder="رمز عبور" required>
            <button type="submit">ورود</button>
        </form>
        <p>حساب کاربری ندارید؟ <a href="javascript:void(0);" id="showRegister">ثبت نام</a></p>
    </div>

    <!-- فرم ثبت نام -->
    <div id="registerContainer" class="form-container" style="display: none;">
        <h2>ثبت نام</h2>
        <form id="registerForm">
            <input type="text" id="name" name="name" placeholder="نام" required>
            <input type="text" id="mobile" name="mobile" placeholder="شماره موبایل" required>
            <input type="password" id="registerPassword" name="registerPassword" placeholder="رمز عبور" required>
            <button type="submit">ثبت نام</button>
        </form>
        <p>قبلاً ثبت‌نام کرده‌اید؟ <a href="javascript:void(0);" id="showLogin">ورود</a></p>
    </div>

    <!-- بازی -->
    <div id="gameContainer">
        <div class="score" id="score"></div>
        <div class="timer" id="timer">زمان باقی‌مانده: 06:50</div>
        <div class="cards-container">
            <div class="card" id="card1"></div>
            <div class="card" id="card2"></div>
            <div class="card" id="card3"></div>
        </div>
        <div class="number-display" id="numberDisplay">--</div>
        <button class="start-btn" id="startButton">شروع بازی</button>
    </div>

    <script>
        let userBalance = localStorage.getItem('userBalance') ? parseInt(localStorage.getItem('userBalance')) : 100000; // موجودی از localStorage خوانده می‌شود
        const scoreDisplay = document.getElementById("score");
        const timerDisplay = document.getElementById("timer");
        const startButton = document.getElementById("startButton");
        let selectedNumbers = [];
        let gameFinished = false;
        let timeLeft = 410; // 6 دقیقه و 50 ثانیه
        let timerInterval;
        let numberInterval;
        let userName;
        let mobileNumber;
        let userPassword;
        let registeredUser = null;

        // تابع به‌روزرسانی موجودی
        function updateBalance(amount) {
            userBalance += amount;
            localStorage.setItem('userBalance', userBalance); // ذخیره موجودی جدید در localStorage
            scoreDisplay.textContent = `سلام ${userName}، موجودی شما: ${userBalance.toLocaleString('fa-IR')} تومان`;
        }

        // تولید کارت‌ها
        function generateCard(cardId) {
            const card = document.getElementById(cardId);
            card.innerHTML = "";

            const columns = [
                Array.from({ length: 11 }, (_, i) => i + 80),
                Array.from({ length: 10 }, (_, i) => i + 70),
                Array.from({ length: 10 }, (_, i) => i + 60),
                Array.from({ length: 10 }, (_, i) => i + 50),
                Array.from({ length: 10 }, (_, i) => i + 40),
                Array.from({ length: 10 }, (_, i) => i + 30),
                Array.from({ length: 10 }, (_, i) => i + 20),
                Array.from({ length: 10 }, (_, i) => i + 10),
                Array.from({ length: 9 }, (_, i) => i + 1),
            ];

            columns.forEach((column) => column.sort(() => Math.random() - 0.5));

            const rows = Array.from({ length: 3 }, () => Array(9).fill(null));
            rows.forEach((row) => {
                const filledColumns = Array.from({ length: 9 }, (_, i) => i)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 5);
                filledColumns.forEach((col) => {
                    row[col] = columns[col].pop();
                });
            });

            rows.flat().forEach((num) => {
                const cell = document.createElement("div");
                cell.classList.add("cell");
                if (num !== null) {
                    cell.textContent = num;
                    cell.classList.add("filled");
                }
                cell.onclick = () => handleCellClick(cell, num);
                card.appendChild(cell);
            });
        }

        // رویداد کلیک روی سلول‌ها
        function handleCellClick(cell, number) {
            if (gameFinished) return;
            if (selectedNumbers.includes(number)) {
                cell.classList.add("selected");
            } else {
                cell.classList.add("missed");
                setTimeout(() => cell.classList.remove("missed"), 1000);
            }
            checkWinCondition();
        }

        // بررسی وضعیت برنده شدن
        function checkWinCondition() {
            const cards = ["card1", "card2", "card3"];
            
            // بررسی این که آیا یک کارت پر شده است یا نه
            for (let cardId of cards) {
                const card = document.getElementById(cardId);
                const cells = card.getElementsByClassName("cell");
                
                let allCellsFilled = true;
                
                Array.from(cells).forEach((cell) => {
                    if (!cell.classList.contains("selected") && cell.classList.contains("filled")) {
                        allCellsFilled = false;
                    }
                });

                // اگر یک کارت تمام سلول‌هایش پر شد، بازی تمام می‌شود و کاربر برنده می‌شود
                if (allCellsFilled) {
                    endGame(true); // بازی به پایان می‌رسد و کاربر برنده می‌شود
                    return; // بعد از پیدا کردن کارت برنده، از تابع خارج می‌شود
                }
            }
        }

        // شروع تایمر
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const seconds = (timeLeft % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `زمان باقی‌مانده: ${minutes}:${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(false);
                }
            }, 1000);
        }

        // تولید عدد تصادفی
        function generateRandomNumber() {
            if (gameFinished) return;
            const number = Math.floor(Math.random() * 90) + 1;
            if (!selectedNumbers.includes(number)) {
                selectedNumbers.push(number);
                document.getElementById("numberDisplay").textContent = number;
            } else {
                generateRandomNumber();
            }
        }

        // شروع بازی
        startButton.onclick = () => {
            if (userBalance <= 0) {
                alert("موجودی شما برای ادامه بازی کافی نیست!");
                return;
            }

            startButton.style.display = "none"; // مخفی کردن دکمه شروع
            selectedNumbers = [];
            gameFinished = false;
            timeLeft = 410; // 6 دقیقه و 50 ثانیه
            generateCard("card1");
            generateCard("card2");
            generateCard("card3");
            startTimer();
            generateRandomNumber(); // تولید اولین عدد تصادفی بلافاصله بعد از شروع بازی
            numberInterval = setInterval(generateRandomNumber, 5000);
        };

        // پایان بازی
        function endGame(isWin) {
            gameFinished = true;
            clearInterval(numberInterval);
            clearInterval(timerInterval);
            if (isWin) {
                updateBalance(50000);
                alert("تبریک! شما برنده شدید!");
            } else {
                updateBalance(-50000);
                alert("زمان شما تمام شد! شما باختید.");
            }
            startButton.style.display = "block"; // نمایش دوباره دکمه شروع
        }

        // نمایش فرم ثبت‌نام و ورود
        document.getElementById("showRegister").onclick = () => {
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("registerContainer").style.display = "block";
        };

        document.getElementById("showLogin").onclick = () => {
            document.getElementById("registerContainer").style.display = "none";
            document.getElementById("loginContainer").style.display = "block";
        };

        // ثبت‌نام
        document.getElementById("registerForm").onsubmit = (event) => {
            event.preventDefault();
            const name = document.getElementById("name").value;
            const mobile = document.getElementById("mobile").value;
            const password = document.getElementById("registerPassword").value;
            localStorage.setItem("userName", name);
            localStorage.setItem("userMobile", mobile);
            localStorage.setItem("userPassword", password);
            localStorage.setItem('userBalance', userBalance); // ذخیره موجودی در هنگام ثبت‌نام
            alert("ثبت نام موفقیت آمیز بود.");
            document.getElementById("registerContainer").style.display = "none";
            document.getElementById("loginContainer").style.display = "block";
        };

        // ورود
        document.getElementById("loginForm").onsubmit = (event) => {
            event.preventDefault();
            const mobile = document.getElementById("loginMobile").value;
            const password = document.getElementById("loginPassword").value;

            const storedMobile = localStorage.getItem("userMobile");
            const storedPassword = localStorage.getItem("userPassword");

            if (mobile === storedMobile && password === storedPassword) {
                userName = localStorage.getItem("userName");
                alert("ورود موفقیت آمیز بود.");
                document.getElementById("loginContainer").style.display = "none";
                document.getElementById("gameContainer").style.display = "block";
                updateBalance(0); // نمایش موجودی بعد از ورود
            } else {
                alert("اطلاعات وارد شده نادرست است.");
            }
        };
    </script>
</body>
</html>
