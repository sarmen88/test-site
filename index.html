<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی دبرنا</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            direction: rtl;
        }
        .cards-container {
            margin: 20px auto;
        }
        .card {
            display: grid;
            grid-template-columns: repeat(9, 60px);
            gap: 5px;
            justify-content: center;
            margin: 20px auto;
        }
        .cell {
            width: 60px;
            height: 60px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #333;
            font-size: 20px;
            line-height: 60px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .cell.filled {
            background-color: #e9ecef;
        }
        .cell.selected {
            background-color: #4caf50;
            color: white;
        }
        .cell.missed {
            background-color: red;
            color: white;
        }
        .number-display {
            font-size: 30px;
            font-weight: bold;
            margin: 20px 0;
            background-color: #007bff;
            color: white;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 50%;
        }
        .score {
            font-size: 20px;
            margin: 10px;
        }
        .timer {
            font-size: 25px;
            font-weight: bold;
            margin: 15px;
            color: #dc3545;
        }
        .start-btn {
            font-size: 18px;
            padding: 10px 20px;
            margin: 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>بازی دبرنا</h1>
    <div class="score" id="score">موجودی شما: ۱۰۰,۰۰۰ تومان</div>
    <div class="timer" id="timer">زمان باقی‌مانده: 06:40</div>
    <div class="cards-container">
        <div class="card" id="card1"></div>
        <div class="card" id="card2"></div>
        <div class="card" id="card3"></div>
    </div>
    <div class="number-display" id="numberDisplay">--</div>
    <button class="start-btn" id="startButton">شروع بازی</button>

    <script>
        let userBalance = 100000; // موجودی اولیه کاربر به تومان
        const scoreDisplay = document.getElementById("score");
        const timerDisplay = document.getElementById("timer");
        const startButton = document.getElementById("startButton");
        let selectedNumbers = []; // ذخیره تمامی اعداد تصادفی
        let gameFinished = false; // نشان‌دهنده پایان بازی
        let timeLeft = 400; // زمان باقی‌مانده: ۶ دقیقه و ۴۰ ثانیه (به ثانیه)
        let timerInterval; // تایمر بازی
        let numberInterval; // فاصله تولید اعداد تصادفی

        // به‌روزرسانی موجودی
        function updateBalance(amount) {
            userBalance += amount;
            scoreDisplay.textContent = `موجودی شما: ${userBalance.toLocaleString('fa-IR')} تومان`;
        }

        // تولید کارت دبرنا
        function generateCard(cardId) {
            const card = document.getElementById(cardId);
            card.innerHTML = ""; // پاک کردن کارت قبلی

            const columns = [
                Array.from({ length: 9 }, (_, i) => i + 1), // ستون 1: 1 تا 9
                Array.from({ length: 10 }, (_, i) => i + 10), // ستون 2: 10 تا 19
                Array.from({ length: 10 }, (_, i) => i + 20), // ستون 3: 20 تا 29
                Array.from({ length: 10 }, (_, i) => i + 30), // ستون 4: 30 تا 39
                Array.from({ length: 10 }, (_, i) => i + 40), // ستون 5: 40 تا 49
                Array.from({ length: 10 }, (_, i) => i + 50), // ستون 6: 50 تا 59
                Array.from({ length: 10 }, (_, i) => i + 60), // ستون 7: 60 تا 69
                Array.from({ length: 10 }, (_, i) => i + 70), // ستون 8: 70 تا 79
                Array.from({ length: 11 }, (_, i) => i + 80), // ستون 9: 80 تا 90
            ];

            columns.forEach((column) => column.sort(() => Math.random() - 0.5)); // تصادفی‌سازی اعداد هر ستون

            const rows = Array.from({ length: 3 }, () => Array(9).fill(null));
            rows.forEach((row) => {
                const filledColumns = Array.from({ length: 9 }, (_, i) => i)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 5); // انتخاب 5 ستون تصادفی

                filledColumns.forEach((col) => {
                    row[col] = columns[col].pop(); // برداشتن عدد از ستون
                });
            });

            rows.flat().forEach((num) => {
                const cell = document.createElement("div");
                cell.classList.add("cell");
                if (num !== null) {
                    cell.textContent = num;
                    cell.classList.add("filled");
                }
                cell.onclick = () => handleCellClick(cell, num, cardId);
                card.appendChild(cell);
            });
        }

        // مدیریت کلیک روی خانه‌ها
        function handleCellClick(cell, number, cardId) {
            if (gameFinished) return; // اگر بازی تمام شده، کلیک‌ها بی‌اثر شوند
            if (selectedNumbers.includes(number)) {
                cell.classList.add("selected");
            } else {
                cell.classList.add("missed");
                setTimeout(() => cell.classList.remove("missed"), 1000); // حذف رنگ قرمز بعد از 1 ثانیه
            }
            checkWinCondition(); // بررسی برنده شدن بعد از هر کلیک
        }

        // بررسی برنده شدن کاربر
        function checkWinCondition() {
            const cards = ["card1", "card2", "card3"];
            let allCellsFilled = true;

            cards.forEach((cardId) => {
                const card = document.getElementById(cardId);
                const cells = card.getElementsByClassName("cell");
                Array.from(cells).forEach((cell) => {
                    if (!cell.classList.contains("selected") && cell.classList.contains("filled")) {
                        allCellsFilled = false;
                    }
                });
            });

            if (allCellsFilled) {
                endGame(true); // اگر تمام خانه‌ها پر شدند، بازی تمام است و کاربر برنده شده
            }
        }

        // شروع تایمر
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const seconds = (timeLeft % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `زمان باقی‌مانده: ${minutes}:${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(false); // پایان بازی در صورت اتمام زمان
                }
            }, 1000);
        }

        // تولید عدد تصادفی
        function generateRandomNumber() {
            if (gameFinished) return;
            const number = Math.floor(Math.random() * 90) + 1; // عدد بین 1 تا 90
            if (!selectedNumbers.includes(number)) {
                selectedNumbers.push(number);
                document.getElementById("numberDisplay").textContent = number;
            } else {
                generateRandomNumber(); // اگر عدد تکراری بود دوباره تلاش کن
            }
        }

        // شروع یا شروع مجدد بازی
        startButton.onclick = () => {
            if (userBalance <= 0) {
                alert("موجودی شما برای ادامه بازی کافی نیست!");
                return;
            }

            startButton.style.display = "none"; // محو کردن دکمه شروع بازی
            selectedNumbers = []; // پاک کردن اعداد قبلی
            gameFinished = false; // بازنشانی وضعیت بازی
            timeLeft = 400; // بازنشانی تایمر
            generateCard("card1"); // تولید کارت اول
            generateCard("card2"); // تولید کارت دوم
            generateCard("card3"); // تولید کارت سوم
            startTimer(); // شروع تایمر
            numberInterval = setInterval(generateRandomNumber, 5000); // تولید عدد تصادفی هر 5 ثانیه
        };

        // پایان بازی
        function endGame(isWin) {
            gameFinished = true;
            clearInterval(numberInterval); // توقف تولید اعداد تصادفی
            if (isWin) {
                updateBalance(50000); // جایزه 50 هزار تومان برای تکمیل کارت
                alert("تبریک! شما کارت را تکمیل کردید. ۵۰,۰۰۰ تومان به موجودی شما افزوده شد.");
            } else {
                updateBalance(-50000); // کاهش 50 هزار تومان در صورت باخت
                alert("زمان شما تمام شد! شما باختید.");
            }
            startButton.style.display = "block"; // نمایش مجدد دکمه شروع بازی
        }
    </script>
</body>
</html>
